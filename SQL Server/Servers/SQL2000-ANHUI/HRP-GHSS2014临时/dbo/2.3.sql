IF OBJECT_ID('TEMPDB..#TEMP1') IS NOT NULL DROP TABLE #TEMP1
SELECT
	A0102,
	HA0102,
	k1302,
	k1303,
	k1304 
INTO #TEMP1 
FROM K001
ORDER BY k1302,k1303

---创建TID空列
EXEC('ALTER TABLE #TEMP1 ADD TID INT')

CREATE CLUSTERED INDEX #TEMP1
	ON #TEMP1 (k1302,k1303)

DECLARE @IW1 INT,@PARENTID1 CHAR(15)

UPDATE #TEMP1
SET 
	@IW1 = CASE WHEN @PARENTID1=k1302 THEN @IW1+1 ELSE 1 END ,
	@PARENTID1 = k1302,
	TID=@IW1 

SELECT 
	A.HA0102,
	A.k1302,
	A.k1303,
	A.k1304,
	B.k1303 		[下一段起点桩号],
	B.k1303-A.k1304 	[下一段起点桩号与上一段止点桩号的差值],
	B.HA0102 		[下一段管理单位名称]
FROM #TEMP1 A 
LEFT JOIN #TEMP1 B ON A.k1302=B.k1302 AND A.TID=B.TID-1
WHERE B.A0102 IS NOT NULL AND B.k1303-A.k1304<0 --and A.K1302='X513340181'

DROP TABLE #TEMP1