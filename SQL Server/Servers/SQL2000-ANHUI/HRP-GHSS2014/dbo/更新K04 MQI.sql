
SELECT A0102,AA,left(a0101a,6),CC,A0203,DD ,
A5010,RTRIM(MQI)	MQI,
A5032,RTRIM(AA5032) AA5032,
isnull(A5033,'0')A5033,RTRIM(AA5033)AA5033,
isnull(A5034,'0')A5034,RTRIM(AA5034)AA5034,
isnull(A5035,'0')A5035,RTRIM(AA5035)AA5035,
isnull(A5036,'0')A5036,RTRIM(AA5036)AA5036
--UPDATE K04 SET A5010=RTRIM(MQI)	,A5032=RTRIM(AA5032),A5033=RTRIM(AA5033),A5034=RTRIM(AA5034),A5035=RTRIM(AA5035),A5036=RTRIM(AA5036)
FROM K04
LEFT JOIN
(
	select
		A0102 AA,
		MAX(ha0102) BB,
		MAX(a0101a) CC,
		LEFT(K0101,1) DD,		CAST(sum(isnull(a5010,0)*isnull(a5008,0))/nullif(sum(isnull(a5008,0)),0) AS NUMERIC(18,2)) MQI,--A5010
		CAST((ISNULL(SUM(CASE WHEN isnull(a5010,0)>=90  THEN isnull(a5008,0) END),'0'))/1000 AS NUMERIC(18,3)) AA5032,
		CAST((ISNULL(SUM(CASE WHEN isnull(a5010,0)>=80 and isnull(a5010,0)<90  THEN isnull(a5008,0) END),'0'))/1000 AS NUMERIC(18,3)) AA5033,
		CAST((ISNULL(SUM(CASE WHEN isnull(a5010,0)>=70 and isnull(a5010,0)<80 THEN isnull(a5008,0) END),'0'))/1000 AS NUMERIC(18,3)) AA5034,
		CAST((ISNULL(SUM(CASE WHEN isnull(a5010,0)>=60 and isnull(a5010,0)<70 THEN isnull(a5008,0) END),'0'))/1000 AS NUMERIC(18,3)) AA5035,
		CAST((ISNULL(SUM(CASE WHEN isnull(a5010,0)<60 	THEN isnull(a5008,0) END),'0'))/1000 AS NUMERIC(18,3)) AA5036
		from k03 a
	where 	ISNULL(K5104,'') IN ('11','12','21','22','23')
		and not(
				CAST(ISNULL(A0129,'') AS VARCHAR(100)) LIKE '%市政道路%' or
				CAST(ISNULL(A0129,'') AS VARCHAR(100)) LIKE '%改扩建施工%' or
				CAST(ISNULL(A0129,'') AS VARCHAR(100)) LIKE '%预防养护施工%' or
				CAST(ISNULL(A0129,'') AS VARCHAR(100)) LIKE '%修复养护施工%' or
				CAST(ISNULL(A0129,'') AS VARCHAR(100)) LIKE '%其他施工-%' or
				CAST(ISNULL(A0129,'') AS VARCHAR(100)) LIKE '%其他单位-%' or
				CAST(ISNULL(A0129,'') AS VARCHAR(100)) LIKE '%缺陷责任期-%'
			)
		and	 left(a0101a,6)='2023'+'43' and A0102 like '34%'
	GROUP BY A0102,LEFT(K0101,1)
)TK04 ON AA=A0102  AND A0203=DD
WHERE left(a0101a,6)='2024'+'43'
--and A5010<>RTRIM(MQI)
and (
A5032<>RTRIM(AA5032)
or isnull(A5033,'0')<>RTRIM(AA5033)
or isnull(A5034,'0')<>RTRIM(AA5034)
or isnull(A5035,'0')<>RTRIM(AA5035)
or isnull(A5036,'0')<>RTRIM(AA5036)
)